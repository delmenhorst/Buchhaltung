<!DOCTYPE html>
<html lang="de" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Buchhaltung{% endblock %}</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Custom Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'apple-blue': '#007AFF',
                        'apple-green': '#34C759',
                        'apple-orange': '#FF9500',
                        'apple-red': '#FF3B30',
                        'apple-gray': {
                            50: '#F5F5F7',
                            100: '#E8E8ED',
                            200: '#D2D2D7',
                            300: '#B0B0B8',
                            400: '#86868B',
                            500: '#636366',
                            600: '#48484A',
                            700: '#3A3A3C',
                            800: '#2C2C2E',
                            900: '#1C1C1E',
                        }
                    },
                    fontFamily: {
                        'sf': ['-apple-system', 'BlinkMacSystemFont', 'SF Pro Display', 'Segoe UI', 'Roboto', 'sans-serif'],
                    },
                    backdropBlur: {
                        'xs': '2px',
                    }
                }
            }
        }
    </script>

    <style>
        /* Apple-style scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        /* Glassmorphism effect */
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        /* Smooth transitions */
        * {
            transition-property: background-color, border-color, color, fill, stroke, opacity, box-shadow, transform;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }
    </style>
</head>
<body class="h-full font-sf antialiased" x-data="{ sidebarOpen: true }">

    <!-- Main Container with Sidebar -->
    <div class="flex h-full">

        <!-- Collapsible Sidebar -->
        <aside
            x-show="sidebarOpen"
            x-transition:enter="transform transition ease-in-out duration-300"
            x-transition:enter-start="-translate-x-full"
            x-transition:enter-end="translate-x-0"
            x-transition:leave="transform transition ease-in-out duration-300"
            x-transition:leave-start="translate-x-0"
            x-transition:leave-end="-translate-x-full"
            class="w-64 bg-white border-r border-apple-gray-200 flex flex-col"
        >
            <!-- Sidebar Header -->
            <div class="p-4 border-b border-apple-gray-200">
                <div class="flex items-center justify-between">
                    <h1 class="text-lg font-semibold text-apple-gray-900">Buchhaltung</h1>
                    <button
                        @click="sidebarOpen = false"
                        class="p-1 rounded-lg hover:bg-apple-gray-100 transition-colors"
                    >
                        <svg class="w-5 h-5 text-apple-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Business Selector -->
            <div class="p-3 border-b border-apple-gray-200 bg-apple-gray-50" x-data="businessSelector()">
                <div class="relative" x-data="{ open: false }">
                    <button
                        @click="open = !open"
                        class="w-full flex items-center justify-between px-3 py-2 text-sm font-medium rounded-lg bg-white border border-apple-gray-300 hover:bg-apple-gray-50 transition-colors">
                        <div class="flex items-center gap-2 flex-1 min-w-0">
                            <div
                                x-show="selectedBusiness"
                                :style="selectedBusiness ? 'background: ' + selectedBusiness.color : ''"
                                class="w-3 h-3 rounded-full flex-shrink-0">
                            </div>
                            <span class="truncate" x-text="selectedBusiness ? selectedBusiness.name : 'Alle Businesses'"></span>
                        </div>
                        <svg class="w-4 h-4 text-apple-gray-500 flex-shrink-0" :class="{'rotate-180': open}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>

                    <!-- Dropdown Menu -->
                    <div
                        x-show="open"
                        @click.away="open = false"
                        x-transition:enter="transition ease-out duration-100"
                        x-transition:enter-start="transform opacity-0 scale-95"
                        x-transition:enter-end="transform opacity-100 scale-100"
                        x-transition:leave="transition ease-in duration-75"
                        x-transition:leave-start="transform opacity-100 scale-100"
                        x-transition:leave-end="transform opacity-0 scale-95"
                        class="absolute z-10 mt-2 w-full bg-white rounded-lg shadow-lg border border-apple-gray-200 overflow-hidden">

                        <!-- "Alle Businesses" Option -->
                        <button
                            @click="selectBusiness(null); open = false"
                            :class="!selectedBusiness ? 'bg-apple-blue/10 text-apple-blue' : 'hover:bg-apple-gray-50'"
                            class="w-full flex items-center gap-2 px-3 py-2 text-sm text-left transition-colors">
                            <div class="w-3 h-3 rounded-full bg-apple-gray-300"></div>
                            <span class="font-medium">Alle Businesses</span>
                        </button>

                        <div class="border-t border-apple-gray-200"></div>

                        <!-- Business List -->
                        <template x-for="business in businesses" :key="business.id">
                            <button
                                @click="selectBusiness(business); open = false"
                                :class="selectedBusiness && selectedBusiness.id === business.id ? 'bg-apple-blue/10' : 'hover:bg-apple-gray-50'"
                                class="w-full flex items-center gap-2 px-3 py-2 text-sm text-left transition-colors">
                                <div :style="'background: ' + business.color" class="w-3 h-3 rounded-full"></div>
                                <span class="flex-1 truncate" x-text="business.name"></span>
                                <span class="text-xs text-apple-gray-500" x-text="business.prefix"></span>
                            </button>
                        </template>

                        <!-- Empty State -->
                        <div x-show="businesses.length === 0" class="px-3 py-6 text-center">
                            <p class="text-xs text-apple-gray-500 mb-2">Keine Businesses angelegt</p>
                            <a href="/settings" class="text-xs text-apple-blue hover:underline">
                                Jetzt erstellen
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="flex-1 p-3 space-y-1 overflow-y-auto" x-data="navigationLinks()">
                <!-- Dashboard -->
                <a :href="getLink('/')" class="flex items-center px-3 py-2 text-sm font-medium rounded-lg hover:bg-apple-gray-100 text-apple-gray-700">
                    <svg class="w-5 h-5 mr-3 text-apple-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                    <span>Dashboard</span>
                </a>

                <!-- Suche -->
                <a :href="getLink('/search')" class="flex items-center px-3 py-2 text-sm font-medium rounded-lg hover:bg-apple-gray-100 text-apple-gray-700">
                    <svg class="w-5 h-5 mr-3 text-apple-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    <span>Suche</span>
                </a>

                <div class="my-3 border-t border-apple-gray-200"></div>

                <!-- Einnahmen -->
                <a :href="getLink('/income')" class="flex items-center px-3 py-2 text-sm font-medium rounded-lg hover:bg-apple-gray-100 text-apple-gray-700 group" x-data="{ incomeCount: 0 }">
                    <svg class="w-5 h-5 mr-3 text-apple-green" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/>
                    </svg>
                    <span class="flex-1">Einnahmen</span>
                    <span x-show="incomeCount > 0" class="px-2 py-0.5 text-xs font-medium bg-apple-green/10 text-apple-green rounded-full" id="income-badge" x-text="incomeCount"></span>
                </a>

                <!-- Ausgaben -->
                <a :href="getLink('/expenses')" class="flex items-center px-3 py-2 text-sm font-medium rounded-lg hover:bg-apple-gray-100 text-apple-gray-700" x-data="{ expenseCount: 0 }">
                    <svg class="w-5 h-5 mr-3 text-apple-orange" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8l-4 4 4 4m10-8l4 4-4 4"/>
                    </svg>
                    <span class="flex-1">Ausgaben</span>
                    <span x-show="expenseCount > 0" class="px-2 py-0.5 text-xs font-medium bg-apple-orange/10 text-apple-orange rounded-full" id="expense-badge" x-text="expenseCount"></span>
                </a>

                <!-- Wiederkehrende Buchungen -->
                <a :href="getLink('/recurring')" class="flex items-center px-3 py-2 text-sm font-medium rounded-lg hover:bg-apple-gray-100 text-apple-gray-700">
                    <svg class="w-5 h-5 mr-3 text-apple-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    <span>Wiederkehrende</span>
                </a>

                <div class="my-3 border-t border-apple-gray-200"></div>

                <!-- EAR-Tabelle -->
                <a :href="getLink('/documents')" class="flex items-center px-3 py-2 text-sm font-medium rounded-lg hover:bg-apple-gray-100 text-apple-gray-700">
                    <svg class="w-5 h-5 mr-3 text-apple-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <span>EAR-Tabelle</span>
                </a>
            </nav>

            <!-- Sidebar Footer -->
            <div class="p-3 border-t border-apple-gray-200">
                <a href="/settings" class="flex items-center px-3 py-2 text-sm font-medium rounded-lg hover:bg-apple-gray-100 text-apple-gray-700">
                    <svg class="w-5 h-5 mr-3 text-apple-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    <span>Einstellungen</span>
                </a>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 flex flex-col min-w-0 bg-apple-gray-50">

            <!-- Top Bar -->
            <header class="glass border-b border-apple-gray-200 sticky top-0 z-10">
                <div class="px-4 py-3 flex items-center justify-between">
                    <!-- Toggle Sidebar Button (when collapsed) -->
                    <button
                        x-show="!sidebarOpen"
                        @click="sidebarOpen = true"
                        class="p-2 rounded-lg hover:bg-apple-gray-100 transition-colors"
                    >
                        <svg class="w-5 h-5 text-apple-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                    </button>

                    <div class="flex-1 px-4">
                        <h2 class="text-lg font-semibold text-apple-gray-900">{% block page_title %}{% endblock %}</h2>
                    </div>

                    <!-- Quick Actions -->
                    <div class="flex items-center space-x-2">
                        <button class="p-2 rounded-lg hover:bg-apple-gray-100 transition-colors" title="Keyboard Shortcuts (âŒ˜K)">
                            <svg class="w-5 h-5 text-apple-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <div class="flex-1 overflow-hidden">
                {% block content %}{% endblock %}
            </div>

        </main>

    </div>

    <!-- Toast Container -->
    <div x-data="toastManager()" @toast.window="showToast($event.detail)" class="fixed top-4 right-4 z-50 space-y-2">
        <template x-for="toast in toasts" :key="toast.id">
            <div
                x-show="toast.show"
                x-transition:enter="transform transition ease-out duration-300"
                x-transition:enter-start="translate-x-full opacity-0"
                x-transition:enter-end="translate-x-0 opacity-100"
                x-transition:leave="transform transition ease-in duration-200"
                x-transition:leave-start="translate-x-0 opacity-100"
                x-transition:leave-end="translate-x-full opacity-0"
                class="flex items-center gap-3 min-w-[320px] max-w-md px-4 py-3 rounded-lg shadow-lg border"
                :class="{
                    'bg-white border-apple-gray-200': toast.type === 'info',
                    'bg-green-50 border-green-200': toast.type === 'success',
                    'bg-red-50 border-red-200': toast.type === 'error',
                    'bg-yellow-50 border-yellow-200': toast.type === 'warning'
                }"
            >
                <!-- Icon -->
                <div class="flex-shrink-0">
                    <svg x-show="toast.type === 'success'" class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <svg x-show="toast.type === 'error'" class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <svg x-show="toast.type === 'warning'" class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <svg x-show="toast.type === 'info'" class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>

                <!-- Message -->
                <div class="flex-1 text-sm font-medium"
                    :class="{
                        'text-apple-gray-900': toast.type === 'info',
                        'text-green-900': toast.type === 'success',
                        'text-red-900': toast.type === 'error',
                        'text-yellow-900': toast.type === 'warning'
                    }"
                    x-text="toast.message">
                </div>

                <!-- Close Button -->
                <button @click="removeToast(toast.id)" class="flex-shrink-0 text-apple-gray-400 hover:text-apple-gray-600 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        </template>
    </div>

    <!-- Global Scripts -->
    <script>
        // Toast Manager Component
        function toastManager() {
            return {
                toasts: [],
                nextId: 1,

                showToast({ message, type = 'info', duration = 4000 }) {
                    const id = this.nextId++;
                    const toast = { id, message, type, show: false };
                    this.toasts.push(toast);

                    // Trigger animation
                    setTimeout(() => {
                        const index = this.toasts.findIndex(t => t.id === id);
                        if (index !== -1) {
                            this.toasts[index].show = true;
                        }
                    }, 10);

                    // Auto-remove after duration
                    setTimeout(() => {
                        this.removeToast(id);
                    }, duration);
                },

                removeToast(id) {
                    const index = this.toasts.findIndex(t => t.id === id);
                    if (index !== -1) {
                        this.toasts[index].show = false;
                        // Remove from array after animation
                        setTimeout(() => {
                            const idx = this.toasts.findIndex(t => t.id === id);
                            if (idx !== -1) {
                                this.toasts.splice(idx, 1);
                            }
                        }, 300);
                    }
                }
            }
        }

        // Global toast helper function
        window.showToast = function(message, type = 'info', duration = 4000) {
            window.dispatchEvent(new CustomEvent('toast', {
                detail: { message, type, duration }
            }));
        };

        // Format number with thousands separator
        function formatCurrency(amount) {
            if (amount === null || amount === undefined) return '0,00';
            const num = parseFloat(amount);
            return num.toLocaleString('de-DE', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Business Selector Component
        function businessSelector() {
            return {
                businesses: [],
                selectedBusiness: null,
                
                init() {
                    // Load businesses from API
                    this.loadBusinesses();

                    // Load selected business from localStorage
                    const savedBusinessId = localStorage.getItem('selectedBusinessId');
                    if (savedBusinessId && savedBusinessId !== 'null') {
                        // Will be set after businesses are loaded
                        this.$watch('businesses', (businesses) => {
                            if (businesses.length > 0 && !this.selectedBusiness) {
                                const saved = businesses.find(b => b.id === parseInt(savedBusinessId));
                                if (saved) {
                                    this.selectedBusiness = saved;
                                }
                            }
                        });
                    }

                    // Listen for business updates (from settings page)
                    window.addEventListener('businesses-updated', () => {
                        this.loadBusinesses();
                    });
                },
                
                async loadBusinesses() {
                    try {
                        const response = await fetch('/api/businesses');
                        this.businesses = await response.json();
                    } catch (error) {
                        console.error('Failed to load businesses:', error);
                    }
                },
                
                selectBusiness(business) {
                    this.selectedBusiness = business;
                    
                    // Save to localStorage
                    if (business) {
                        localStorage.setItem('selectedBusinessId', business.id);
                    } else {
                        localStorage.removeItem('selectedBusinessId');
                    }
                    
                    // Dispatch event for other components to listen
                    window.dispatchEvent(new CustomEvent('business-changed', {
                        detail: { business: business }
                    }));
                    
                    // Reload page to apply filter
                    window.location.reload();
                }
            }
        }
        
        // Get current selected business ID (helper function for pages)
        function getSelectedBusinessId() {
            const savedId = localStorage.getItem('selectedBusinessId');
            return savedId && savedId !== 'null' ? parseInt(savedId) : null;
        }
        
        // Navigation Links Component - adds business_id to URLs
        function navigationLinks() {
            return {
                getLink(path) {
                    const businessId = getSelectedBusinessId();
                    if (businessId) {
                        const separator = path.includes('?') ? '&' : '?';
                        return `${path}${separator}business_id=${businessId}`;
                    }
                    return path;
                }
            }
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Cmd/Ctrl + K for search
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                e.preventDefault();
                window.location.href = '/search';
            }

            // Cmd/Ctrl + B to toggle sidebar
            if ((e.metaKey || e.ctrlKey) && e.key === 'b') {
                e.preventDefault();
                Alpine.store('sidebarOpen', !Alpine.store('sidebarOpen'));
            }
        });

        // Update badge counts
        function updateBadges() {
            const businessId = getSelectedBusinessId();
            const url = businessId
                ? `/api/inbox-counts?business_id=${businessId}`
                : '/api/inbox-counts';

            fetch(url)
                .then(r => r.json())
                .then(data => {
                    const incomeBadge = document.getElementById('income-badge');
                    const expenseBadge = document.getElementById('expense-badge');

                    // Update badge text content
                    incomeBadge.textContent = data.income || 0;
                    expenseBadge.textContent = data.expenses || 0;

                    // Update Alpine.js data for visibility control
                    const incomeLink = incomeBadge.closest('a');
                    const expenseLink = expenseBadge.closest('a');

                    if (incomeLink && incomeLink.__x) {
                        incomeLink.__x.$data.incomeCount = data.income || 0;
                    }
                    if (expenseLink && expenseLink.__x) {
                        expenseLink.__x.$data.expenseCount = data.expenses || 0;
                    }
                });
        }

        // Update on page load
        updateBadges();

        // Refresh every 30 seconds
        setInterval(updateBadges, 30000);
        
        // Update badges when business changes
        window.addEventListener('business-changed', updateBadges);
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>
